<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>RF Link Planner Tool</title>

   <!-- ✅ Safe Leaflet links -->
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

   <style>
      body {
         margin: 0;
         font-family: "Segoe UI", sans-serif;
         display: flex;
         height: 100vh;
         background: #f8f9fa;
      }

      /* Sidebar */
      #sidebar {
         width: 280px;
         background: #ffffff;
         box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
         padding: 15px;
         display: flex;
         flex-direction: column;
         z-index: 1000;
      }

      #sidebar h2 {
         margin-top: 0;
         color: #20394d;
         font-size: 20px;
         border-bottom: 2px solid #20394d;
         padding-bottom: 5px;
      }

      .form-group {
         margin-bottom: 10px;
      }

      label {
         font-size: 14px;
         color: #20394d;
      }

      input {
         width: 90%;
         padding: 6px;
         margin-top: 5px;
         border: 1px solid #ccc;
         border-radius: 5px;
      }

      button {
         padding: 6px 10px;
         background: #20394d;
         color: white;
         border: none;
         border-radius: 5px;
         cursor: pointer;
         margin-top: 5px;
      }

      button:hover {
         background: #365b81;
      }

      #towerList {
         flex: 1;
         overflow-y: auto;
         margin-top: 10px;
         border-top: 1px solid #ddd;
         padding-top: 10px;
      }

      .tower-item {
         background: #edf2fa;
         border-radius: 8px;
         padding: 10px;
         margin-bottom: 8px;
         font-size: 14px;
         line-height: 1.4;
      }

      .tower-item button {
         background: #e74c3c;
         border: none;
         color: white;
         padding: 3px 6px;
         border-radius: 4px;
         cursor: pointer;
         font-size: 12px;
         float: right;
      }

      .tower-item button:hover {
         background: #c0392b;
      }

      #map {
         flex: 1;
         height: 100%;
      }

      header {
         position: fixed;
         width: 100%;
         text-align: center;
         background: #20394d;
         color: white;
         padding: 8px 0;
         top: 0;
         left: 0;
         z-index: 900;
      }

      .map-container {
         flex: 1;
         position: relative;
         padding: 40px 0 0;
      }

      /* Tooltip for link info */
      .leaflet-tooltip.link-info {
         background: rgba(32, 57, 77, 0.9);
         color: white;
         border: none;
         border-radius: 5px;
         font-size: 13px;
         padding: 6px 8px;
         font-weight: 500;
      }
   </style>
</head>

<body>
   <div id="sidebar">
      <h2>🗼 RF Link Planner</h2>

      <div class="section">
         <p><strong>Instructions:</strong><br>
            Click the Frequency section set the Frequency<br>
            Add a tower on map.<br>
            Towers with same frequency can be linked.<br>
            Click link to show Fresnel zone.</p>
      </div>

      <div class="form-group">
         <label><strong>Frequency (GHz)</strong></label>
         <input id="freqInput" type="number" step="0.1" value="5" />
      </div>

      <button id="addTowerBtn">Add Tower Mode</button>

      <h3 style="margin-top: 15px; color:#20394d;">Towers</h3>
      <div id="towerList"></div>
   </div>

   <div class="map-container">
      <header>RF Outdoor Link Planner</header>
      <div id="map"></div>
   </div>

   <script>
      const map = L.map("map").setView([20.5937, 78.9629], 5);

      // ✅ Use OpenStreetMap tiles
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
         maxZoom: 19,
         attribution: "© OpenStreetMap",
      }).addTo(map);

      let towerMode = false;
      let towers = [];
      let links = [];
      let selectedTower = null;

      const addTowerBtn = document.getElementById("addTowerBtn");
      const towerList = document.getElementById("towerList");

      addTowerBtn.addEventListener("click", () => {
         towerMode = !towerMode;
         addTowerBtn.textContent = towerMode ? "Click Map to Add Tower" : "Add Tower Mode";
      });

      map.on("click", (e) => {
         if (!towerMode) return;
         const freqGHz = parseFloat(document.getElementById("freqInput").value);
         const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
         marker.bindPopup(`Tower ${towers.length + 1}<br>Freq: ${freqGHz} GHz`).openPopup();

         const tower = { id: towers.length + 1, freqGHz, marker, latlng: e.latlng };
         towers.push(tower);
         updateTowerList();

         marker.on("click", () => handleTowerClick(tower));
         marker.on("dragend", (ev) => {
            tower.latlng = ev.target.getLatLng();
            updateTowerList();
         });
      });

      function handleTowerClick(tower) {
         if (!selectedTower) {
            selectedTower = tower;
            alert(`Selected Tower ${tower.id}. Now select another tower to connect.`);
            return;
         }

         if (selectedTower.id === tower.id) {
            alert("Cannot connect a tower to itself.");
            selectedTower = null;
            return;
         }

         if (selectedTower.freqGHz !== tower.freqGHz) {
            alert("Frequencies don't match! Cannot connect.");
            selectedTower = null;
            return;
         }

         const link = L.polyline([selectedTower.latlng, tower.latlng], { color: "blue" }).addTo(map);

         // Calculate distance and add hover tooltip
         const distanceMeters = map.distance(selectedTower.latlng, tower.latlng);
         const distanceKm = (distanceMeters / 1000).toFixed(2);
         const tooltipText = `📶 ${selectedTower.freqGHz} GHz<br>📏 ${distanceKm} km`;
         link.bindTooltip(tooltipText, {
            permanent: false,
            direction: "top",
            className: "link-info",
            sticky: true,
         });

         links.push({ tower1: selectedTower, tower2: tower, line: link });

         link.on("click", () => showFresnelZone(selectedTower, tower, link));

         selectedTower = null;
      }

      function showFresnelZone(t1, t2, line) {
         const freqHz = t1.freqGHz * 1e9;
         const c = 3e8;
         const lambda = c / freqHz;

         const d = map.distance(t1.latlng, t2.latlng);
         const d1 = d / 2;
         const d2 = d / 2;
         const r = Math.sqrt((lambda * d1 * d2) / (d1 + d2));

         const midpoint = L.latLng(
            (t1.latlng.lat + t2.latlng.lat) / 2,
            (t1.latlng.lng + t2.latlng.lng) / 2
         );

         const ellipse = L.circle(midpoint, {
            radius: r,
            color: "red",
            fillColor: "rgba(255,0,0,0.2)",
         }).addTo(map);

         setTimeout(() => map.removeLayer(ellipse), 4000);
      }

      function updateTowerList() {
         towerList.innerHTML = "";

         towers.forEach((t) => {
            const div = document.createElement("div");
            div.className = "tower-item";
            div.innerHTML = `
          <strong>ID:</strong> ${t.id}<br>
          <strong>Freq:</strong> ${t.freqGHz} GHz<br>
          <strong>Lat:</strong> ${t.latlng.lat.toFixed(3)}<br>
          <strong>Lng:</strong> ${t.latlng.lng.toFixed(3)}
          <button onclick="deleteTower(${t.id})">Delete</button>
        `;
            towerList.appendChild(div);
         });
      }

      window.deleteTower = function (id) {
         const tower = towers.find((t) => t.id === id);
         if (!tower) return;

         map.removeLayer(tower.marker);

         // Remove all links associated with this tower
         links = links.filter((link) => {
            if (link.tower1.id === id || link.tower2.id === id) {
               map.removeLayer(link.line);
               return false;
            }
            return true;
         });

         towers = towers.filter((t) => t.id !== id);
         updateTowerList();
      };
   </script>
</body>

</html>